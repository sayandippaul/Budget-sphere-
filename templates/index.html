<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>BudgetSphere - Financial Services Website Template</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
    <!-- Favicon -->
    <link href="{{ url_for('static', filename='img/favicon.ico') }}" rel="icon">

    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <style>
    .character-container {
      position: fixed;
      bottom: 20px;
      left: 20px;
      display: flex;
      align-items: flex-end;
      z-index: 1000;
    }
    .character-img {
      width: 90px;
      border-radius: 100%;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      transition: transform 0.3s ease;
      margin:auto;
    }
    .chat-box {
      background: white;
      border-radius: 22px;
      padding: 15px 20px;
      margin-left: 15px;
      box-shadow: 0 0 10px rgba(0,0,0,0.15);
      max-width: 200px;
      background:url('static/img/chatbot_background.jpeg') no-repeat center center;
      background-size: cover;
    }
    .chat-box p {
      margin: 0;
      font-size: 12px;
    }
    .input-box {
      margin-top: 10px;
    }
    .input-box input {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
    }
    .next-btn {
      background-color: #4a90e2;
      color: white;
      border: none;
      padding: 8px 14px;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 10px;
      float: right;
    }
  </style>
    <link
        href="https://fonts.googleapis.com/css2?family=Jost:wght@500;600;700&family=Open+Sans:wght@400;500&display=swap"
        rel="stylesheet">


    <!-- Icon Font Stylesheet -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Libraries Stylesheet -->
    <link href="{{ url_for('static', filename='lib/animate/animate.min.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='lib/owlcarousel/assets/owl.carousel.min.css') }}" rel="stylesheet">

    <!-- Customized Bootstrap Stylesheet -->
    <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">

    <!-- Template Stylesheet -->
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
</head>

<body>
    <!-- Spinner Start -->
    <div id="spinner"
        class="show bg-white position-fixed translate-middle w-100 vh-100 top-50 start-50 d-flex align-items-center justify-content-center">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
    </div>
    <!-- Spinner End -->

 <div  class="character-container">
    <img onclick="startChat();" src="static/img/chatbot_background.png" style="transform: scaleX(-1);" alt="Character" class="character-img" />
    <div class="chat-box" id="chatBox">
      <p id="chatText">Hello! I'm Finny ðŸ¦Š. What's your name?</p>
      <div class="input-box" id="inputContainer">
        <input type="text" id="userInput" placeholder="Type your answer..." />
        <button class="next-btn" onclick="nextStep()">Next</button>
      </div>
    </div>
  </div>

    <!-- Navbar Start -->
<div class="container-fluid fixed-top px-0 wow fadeIn" data-wow-delay="0.1s">
    <div class="top-bar row gx-0 align-items-center d-none d-lg-flex">
        <div class="col-lg-6 px-5 text-start">
            <small><i class="fa fa-map-marker-alt text-primary me-2"></i>Hack4Bengal</small>
            <small class="ms-4"><i class="fa fa-clock text-primary me-2"></i>20th june -22nd june</small>
        </div>
       
    </div>

    <nav class="navbar navbar-expand-lg navbar-light py-lg-0 px-lg-5 wow fadeIn" data-wow-delay="0.1s">
        <a href="{{ url_for('home') }}" class="navbar-brand ms-4 ms-lg-0">
            <h1 class="display-5 text-primary m-0">BudgetSphere</h1>
        </a>
        <button type="button" class="navbar-toggler me-4" data-bs-toggle="collapse" data-bs-target="#navbarCollapse">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarCollapse">
            <div class="navbar-nav ms-auto p-4 p-lg-0">
                <a id="signin-button"  class=" py-3 px-5  btn btn-primary">Connect Email</a>
                 </div>
            
        </div>
    </nav>
</div>
<!-- Navbar End -->

<!-- Carousel Start -->
<div class="container-fluid p-0 mb-5 wow fadeIn" data-wow-delay="0.1s">
    <div id="header-carousel" class="carousel slide carousel-fade" data-bs-ride="carousel">
        <div class="carousel-inner">
            <div class="carousel-item active">
                <img class="w-100" src="{{ url_for('static', filename='img/carousel-1.jpg') }}" alt="Image">
                <div class="carousel-caption">
                    <div class="container">
                        <div class="row justify-content-start">
                            <div class="col-lg-8">
                                <p class="d-inline-block border border-white rounded text-primary fw-semi-bold py-1 px-3 animated slideInDown">
                                    Welcome to BudgetSphere</p>
                                <h1 class="display-1 mb-4 animated slideInDown">Your Financial Status Is Our Goal</h1>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="carousel-item">
                <img class="w-100" src="{{ url_for('static', filename='img/carousel-2.jpg') }}" alt="Image">
                <div class="carousel-caption">
                    <div class="container">
                        <div class="row justify-content-start">
                            <div class="col-lg-7">
                                <p class="d-inline-block border border-white rounded text-primary fw-semi-bold py-1 px-3 animated slideInDown">
                                    Welcome to BudgetSphere</p>
                                <h1 class="display-1 mb-4 animated slideInDown">True Financial Support For You</h1>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <button class="carousel-control-prev" type="button" data-bs-target="#header-carousel" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Previous</span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#header-carousel" data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Next</span>
        </button>
    </div>
</div>
<!-- Carousel End -->

<div class="container-fluid callback my-5 pt-5">
</div>
  
    <!-- Features Start -->
 <div class="  container-xxl feature py-5">
        <div class="container">
            <div class="row g-5 align-items-center">
                <div class="col-lg-6 wow fadeInUp" data-wow-delay="0.1s">
                    <p class="d-inline-block border rounded text-primary fw-semi-bold py-1 px-3">See your profile</p>
                    <h1 class="display-5 mb-4">Your Profile and Dashboard</h1>
                    <p class="mb-4">Connect Your Financial Profile With Us And Get The Best Financial
                        Services. We Will Help You To Manage Your Budget, Expenses, Savings And Investments.</p>
                    </p>
                </div>
                <div class="col-lg-6">
                    <div class="row g-4 align-items-center">
                        <div class="col-md-6">
                            <div class="row g-4">
                                <div class="col-12 wow fadeIn" data-wow-delay="0.3s">
                                    <div class="feature-box border rounded p-4">
                                        <i class="fa fa-check fa-3x text-primary mb-3"></i>
                                        <h4 class="mb-3">ðŸ“© Smart Email & Statement Analysis</h4>
                                        <p class="mb-3">Empowering your money, one email at a time.</p>
                                        
                                    </div>
                                </div>
                                <div class="col-12 wow fadeIn" data-wow-delay="0.5s">
                                    <div class="feature-box border rounded p-4">
                                        <i class="fa fa-check fa-3x text-primary mb-3"></i>
                                        <h4 class="mb-3">ðŸ’¼ Personalized Budget Planning</h4>
                                        <p class="mb-3">Smart budgeting meets seamless automation.</p>
                                        </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 wow fadeIn" data-wow-delay="0.7s">
                            <div class="feature-box border rounded p-4">
                                <i class="fa fa-check fa-3x text-primary mb-3"></i>
                                <h4 class="mb-3">ðŸ“ˆ AI-Powered Saving & Investment Guidance</h4>
                                <p class="mb-3">From income to investment â€” plan with precision.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

   
    <!-- Features End -->


    <!-- Service Start -->
    <div class="container-xxl service py-5">
        <div class="container">
            <div class="text-center mx-auto wow fadeInUp" data-wow-delay="0.1s" style="max-width: 600px;">
                <p class="d-inline-block border rounded text-primary fw-semi-bold py-1 px-3">Our Services</p>
                <h1 class="display-5 mb-5">Automated budgeting through email analysis with smart saving and investing.</h1>
            </div>
            <div class="row g-4 wow fadeInUp" data-wow-delay="0.3s">
                <div class="col-lg-4">
                    <div class="nav nav-pills d-flex justify-content-between w-100 h-100 me-4">
                      <button class="nav-link w-100 d-flex align-items-center text-start border p-4 mb-4 active"
                            data-bs-toggle="pill" data-bs-target="#tab-pane-1" type="button">
                            <h5 class="m-0"><i class="fa fa-bars text-primary me-3"></i>Your Profile </h5>
                        </button>
                   
                        <button class="nav-link w-100 d-flex align-items-center text-start border p-4 mb-4 "
                            data-bs-toggle="pill" data-bs-target="#tab-pane-2" type="button">
                            <h5 class="m-0"><i class="fa fa-bars text-primary me-3"></i>Budget Advisory</h5>
                        </button>
                        <button class="nav-link w-100 d-flex align-items-center text-start border p-4 mb-4"
                            data-bs-toggle="pill" data-bs-target="#tab-pane-3" type="button">
                            <h5 class="m-0"><i class="fa fa-bars text-primary me-3"></i>Investment Planning</h5>
                        </button>
                      
                         </div>
                </div>
                <div class="col-lg-8">
                    <div class="tab-content w-100">
                        <div class="tab-pane fade show active" id="tab-pane-1">
                            <div class="row g-4">
                                <div class="col-md-6" style="min-height: 350px;">
                                    <div class="position-relative h-100">
                                        <img class="position-absolute rounded w-100 h-100" src="{{ url_for('static', filename='img/service-1.jpg') }}" style="object-fit: cover;" alt="">
      
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h3 class="mb-4">Only one email can reduce expenses</h3>
                                    <p class="mb-4">Connect Your Email Account to get proper planning </p>
                                    <p><i class="fa fa-check text-primary me-3"></i>Gets Content of Email</p>
                                    <p><i class="fa fa-check text-primary me-3"></i>Upload bank statement</p>
                                    <input type="file" class="btn btn-primary py-3 px-5 mt-3" id="pdfInput" accept="application/pdf">
                                    <a onclick="analyze();" class="btn btn-primary py-3 px-5 mt-3">Analyze Emails</a>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="tab-pane-2">
                            <div class="row g-12">
                                <div class="col-md-12">
                                    <h3 class="mb-4">Plan your Budget and track expense</h3>
                                    <div id="budget"></div>
                                     </div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="tab-pane-3">
                            <div class="row g-12">
                                <div class="col-md-12">
                                     <h3 class="mb-4">Plan your Savings and Invest expense</h3>
                                    <div id="invest"></div>  </div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="tab-pane-4">
                            <div class="row g-4">
                                <div class="col-md-6" style="min-height: 350px;">
                                    <div class="position-relative h-100">
                                       <img class="position-absolute rounded w-100 h-100" src="{{ url_for('static', filename='img/service-4.jpg') }}" style="object-fit: cover;" alt="">
       </div>
                                </div>
                                <div class="col-md-6">
                                    <h3 class="mb-4">25 Years Of Experience In Financial Support</h3>
                                    <p class="mb-4">Tempor erat elitr rebum at clita. Diam dolor diam ipsum sit. Aliqu
                                        diam amet diam et eos. Clita erat ipsum et lorem et sit, sed stet lorem sit
                                        clita duo justo erat amet.</p>
                                    <p><i class="fa fa-check text-primary me-3"></i>Secured Loans</p>
                                    <p><i class="fa fa-check text-primary me-3"></i>Credit Facilities</p>
                                    <p><i class="fa fa-check text-primary me-3"></i>Cash Advanced</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Service End -->


  <!-- Callback Start -->
<!-- Callback End -->
<!-- Footer Start -->
<div class="container-fluid bg-dark text-light footer mt-5 py-5 wow fadeIn" data-wow-delay="0.1s">
    <div class="container py-5 mx-5">
          
            <div style="margin:auto" class=" col-md-12">
                <h4 class="text-white mb-4">Team Member</h4>
                <a class="btn btn-link" href="">Arka Mandal</a>
                <a class="btn btn-link" href="">Ishika Senapati</a>
                <a class="btn btn-link" href="">Sayandip Paul</a>
            </div>
          
    </div>
</div>
<!-- Footer End -->



    <!-- Back to Top -->
    <a href="#" class="btn btn-lg btn-primary btn-lg-square rounded-circle back-to-top"><i
            class="bi bi-arrow-up"></i></a>


    <!-- JavaScript Libraries -->
    <!-- External CDN JS -->
<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Local JS Libraries -->
<script src="{{ url_for('static', filename='lib/wow/wow.min.js') }}"></script>
<script src="{{ url_for('static', filename='lib/easing/easing.min.js') }}"></script>
<script src="{{ url_for('static', filename='lib/waypoints/waypoints.min.js') }}"></script>
<script src="{{ url_for('static', filename='lib/owlcarousel/owl.carousel.min.js') }}"></script>
<script src="{{ url_for('static', filename='lib/counterup/counterup.min.js') }}"></script>

<!-- Your Main JS -->
<script src="{{ url_for('static', filename='js/main.js') }}"></script>


<script>
    const chatText = document.getElementById("chatText");
    const userInput = document.getElementById("userInput");

   const flow = [
{ text: "Hi there! I'm Finny . What's your name?", field: "name" },
{ text: "Nice to meet you, {name}! Let me show you how BudgetSphere works.", field: "name" },
{ text: "First, you'll need to connect your email. We'll scan your inbox for transaction-related messages.", field: "name" },
{ text: "Based on those emails, we'll create a personalized budget just for you! ", field: "name" },
{ text: "We'll also give you tips on how to save more and invest smarter.", field: "name" },
{ text: "Please go ahead and connect your email to continue.", field: "name" },
{ text: "Next, upload your bank statement in PDF format.", field: "name" },
{ text: "Awesome! We'll now analyze your emails and bank data to build your financial roadmap.", field: "name" },
{ text: "You're all set! Letâ€™s begin your financial journey! ", field: null }
];
    const userData = {};
    let step = 0;
      document.getElementById("chatBox").style.display = "none";

function startChat() {
  step=0;
      document.getElementById("chatBox").style.display = "block";
      document.getElementById("userInput").style.display = "block";
      document.getElementById("userInput").value = "";
      userInput.focus();
      speakText(flow[step].text);
    }

    function nextStep() {
      const value = userInput.value.trim();
      if (value === "" && flow[step].field) return;

      const field = flow[step].field;
      if (field==null) {
        document.getElementById("chatBox").style.display = "none";
        step=0;
       }
      if (field) {
        userData[field] = value;
      }

      step++;
      speakText(flow[step].text);

      if (step < flow.length) {
        let nextText = flow[step].text;
        Object.keys(userData).forEach(key => {
          nextText = nextText.replace(`{${key}}`, userData[key]);
        });
        chatText.innerText = nextText;
        if (step>0) document.getElementById("userInput").style.display = "none";
      }
    }

    function speakText(text) {
  if ('speechSynthesis' in window) {
    const synth = window.speechSynthesis;
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'en-US'; // Set language

    // Wait for voices to be loaded before selecting
    const setFemaleVoice = () => {
      const voices = synth.getVoices();
      // Try to find a female English voice
      const femaleVoice = voices.find(voice =>
        voice.lang.startsWith('en') &&
        (voice.name.toLowerCase().includes('female') || voice.name.toLowerCase().includes('woman') || voice.name.toLowerCase().includes('samantha'))
      );

      if (femaleVoice) {
        utterance.voice = femaleVoice;
      } else {
        // fallback: pick any English voice
        utterance.voice = voices.find(voice => voice.lang.startsWith('en')) || null;
      }

      synth.speak(utterance);
    };

    // Some browsers need a timeout or event
    if (synth.getVoices().length === 0) {
      // Chrome workaround: wait for the voiceschanged event
      window.speechSynthesis.onvoiceschanged = setFemaleVoice;
    } else {
      setFemaleVoice();
    }
  } else {
    console.warn("Speech synthesis not supported in this browser.");
  }
}

  </script>

   <script>
    const pdfInput = document.getElementById('pdfInput');
   // const textOutput = document.getElementById('textOutput');

    pdfInput.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file && file.type === "application/pdf") {
        const fileReader = new FileReader();
        fileReader.onload = function() {
          const typedarray = new Uint8Array(this.result);

          pdfjsLib.getDocument(typedarray).promise.then(async function(pdf) {
            let fullText = '';
            for (let i = 1; i <= pdf.numPages; i++) {
              const page = await pdf.getPage(i);
              const textContent = await page.getTextContent();
              const text = textContent.items.map(item => item.str).join(' ');
              fullText += `\n\n--- Page ${i} ---\n\n${text}`;
            }
            //textOutput.value = fullText.trim();
            console.log(fullText.trim());
            senddata(fullText.trim());
            
          });
        };
        fileReader.readAsArrayBuffer(file);
      } else {
        alert("Please upload a valid PDF file.");
      }
    });
  </script>


 <script>
    const SCOPES = 'https://www.googleapis.com/auth/gmail.readonly';
    let tokenClient;
    let gapiInited = false;
    let gisInited = false;
    let emailBodies = [];

    function gapiLoaded() {
      gapi.load('client', initializeGapiClient);
    }

    async function initializeGapiClient() {
      await gapi.client.init({
        apiKey: 'AIzaSyDcpeWWqbxbldfmuFvnR0pe9F7PqsGzFNo',
        discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest'],
      });
      gapiInited = true;
      maybeEnableButtons();
    }

    function gisLoaded() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: '31628992962-m5n46j7rb9to747vgnufnn0ks2clb3je.apps.googleusercontent.com',
        scope: SCOPES,
        callback: '',
      });
      gisInited = true;
      maybeEnableButtons();
    }

    function maybeEnableButtons() {
      if (gapiInited && gisInited) {
        document.getElementById("signin-button").innerHTML = '<button class="   btn btn-primary" onclick="handleAuthClick()">Sign In & Load Emails</button>';
      }
    }

    function handleAuthClick() {
      tokenClient.callback = async (resp) => {
        if (resp.error) throw resp;
        await listMessages();
      };
      tokenClient.requestAccessToken({ prompt: 'consent' });
    }

    function signOut() {
      google.accounts.oauth2.revoke(tokenClient.access_token, () => {
        document.getElementById("email-list").innerHTML = '';
        emailBodies = [];
        alert("Signed out");
      });
    }

    var emailBodie = "";
    async function listMessages() {
      const response = await gapi.client.gmail.users.messages.list({ userId: 'me', maxResults: 5 });
      const messages = response.result.messages || [];
     // document.getElementById('email-list').innerHTML = '';

      for (const msg of messages) {
        const msgDetail = await gapi.client.gmail.users.messages.get({ userId: 'me', id: msg.id, format: 'full' });
        let body = '';
        const parts = msgDetail.result.payload.parts;
        if (parts && parts.length) {
          for (const part of parts) {
            if (part.mimeType === 'text/plain' && part.body?.data) {
              body = atob(part.body.data.replace(/-/g, '+').replace(/_/g, '/'));
              break;
            }
          }
        } else if (msgDetail.result.payload.body?.data) {
          body = atob(msgDetail.result.payload.body.data.replace(/-/g, '+').replace(/_/g, '/'));
        }
        
        emailBodie=emailBodie + body;
       //const li = document.createElement('li');
        //li.innerText = body ;
        //document.getElementById('email-list').appendChild(li);
      }
    }
    async function analyze() {
      if (emailBodie === "") {
        alert("Please connect your email first.");
        return;
      }
      await senddata(emailBodie);
    }
    async function  senddata(emailBodie) {
           const result = await fetch("/analyze", {
        method: "POST",
        headers: {
          Accept: "application/json",
            "Content-Type": "application/json",
            "Access-Control-Allow-Headers": "Content-Type",
            "Access-Control-Allow-Methods": "GET, POST, PUT, DELETE, OPTIONS",
            "Access-Control-Allow-Origin": "*", },
        body: JSON.stringify({ "email":emailBodie})
      });
      const r = await result.json();
      console.log(r);
      var finaldata=parseFinanceTextToJSON(r);

      document.getElementById("budget").innerHTML=finaldata.budget;
      document.getElementById("invest").innerHTML=finaldata.invest;
    }
     // senddata("hello this is a test email with income 1000, fixed expenses 200, essential expenses 300, lifestyle expenses 400, savings 500");
    

    async function analyzeTransactions() {
      const prompt = `You are an AI that reads multiple email bodies related to bank or payment transactions.\nFrom all email bodies given below, extract 5 values:\n1. income\n2. fixed expenses\n3. essentials expenses\n4. lifestyle expenses\n5. savings\n\nOutput format: [income, fixed, essentials, lifestyle, savings]\n\nRules:\n- If none of these can be found in any email, return: [-1, -1, -1, -1, -1]\n- If any one of these is not found, return 0 in its place\n\nEMAIL BODIES:\n${emailBodies.join('\n')}`;

      const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=AIzaSyA3wIbJGWIc_5RlrtxfdwwN6lzF5xTZ-Vc', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: prompt }] }]
        })
      });

      var result = await response.json();
      
      console.log(result);
      var result1 = JSON.parse(result).r;
      console.log(result1.r);
      //document.getElementById('gemini-response').innerText = JSON.stringify(result, null, 2);
    }
function parseFinanceTextToJSON(rawText) {
  // Step 1: Remove ``` and ```html tags
  const cleaned = rawText
    .replace(/```html/g, '')
    .replace(/```/g, '')
    .trim();

  // Step 2: Split the text into budget and invest sections using %break%
  const [budgetText, investText] = cleaned.split('%break%').map(part => part.trim());

  // Step 3: Return structured JSON
  const result = {
    budget: budgetText,
    invest: investText
  };

  return result;
}

// Example usage

    window.onload = () => {
      gapiLoaded();
      gisLoaded();
    };
  </script>

</body>

</html>